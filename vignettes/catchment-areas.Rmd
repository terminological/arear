---
title: "Dynamic hospital catchment area estimation using label propagation"
author: "Rob Challen"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: true
knit: (function(inputFile, encoding,...) {
  rmarkdown::render(
    inputFile,
    encoding = encoding,
    output_dir = "~/Dropbox/covid19/catchment-areas", output_file=paste0('catchment-areas-',Sys.Date(),'.pdf'))
  })
# output:
#   word_document :
#     fig_caption: yes
#     fig_width: 7
# knit: (function(inputFile, encoding,...) {
#   rmarkdown::render(
#     inputFile,
#     encoding = encoding,
#     output_dir = "~/Dropbox/covid19/catchment-areas", output_file=paste0('catchment-areas-',Sys.Date(),'.docx'))
#   })
# TODO: https://www.reed.edu/data-at-reed/software/R/markdown_multiple_reports.html
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage[ruled,vlined]{algorithm2e}
fig_width: 7
fig_height: 5
out.width: "100%"
bibliography: catchment-areas.bib
csl: catchment-areas.csl
---

Robert Challen^1,2^; Gareth Griffith^3^; Lucas Lacasa^4^; Krasimira Tsaneva-Atanasova^1,5,6^; 

1)  EPSRC Centre for Predictive Modelling in Healthcare, University of Exeter, Exeter, Devon, UK.
2)  Somerset NHS Foundation Trust, Taunton, Somerset, UK.
3)  Bristol Medical School, Population Health Sciences, University of Bristol, Bristol, UK
4)  School of Mathematical Sciences, Queen Mary University of London, London E1 4NS, UK
5)  The Alan Turing Institute, British Library, 96 Euston Rd, London NW1 2DB, UK.
6)  Data Science Institute, College of Engineering, Mathematics and Physical Sciences, University of Exeter, Exeter, UK.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align="center"
)

devtools::load_all("~/Git/standard-print-output/")
devtools::load_all("~/Git/uk-covid-datatools/")

library(tidyverse)
library(patchwork)
library(rgdal)
library(ggplot2)
library(ggspatial)
library(rgeos)
library(maptools)
library(patchwork)
library(sp)
library(sf)

ggplot2::theme_set(standardPrintOutput::defaultFigureLayout())
standardPrintOutput::setDefaults()
ukcovidtools::reload() #setup()

.figCap = captioner::captioner(prefix="Figure")
.tabCap = captioner::captioner(prefix="Table")
fig = function(id,caption="") .figCap(id,caption,display=ifelse(caption=="","c","f"))
tab = function(id,caption="") .tabCap(id,caption,display=ifelse(caption=="","c","f"))
```

# Introduction

During the COVID-19 pandemic, the rapid assessment of the available capacity of a hospital and the potential demand on its services has been important in identifying geographical areas where hospital services are at risk of becoming overwhelmed. Along with epidemic dynamics, residual hospital capacity guides the imposition of public health measures such as social distancing. The problem faced in assessing the load on a hospital due to COVID-19 is that the demand may be highly variable in space and rapidly changing in time, whilst available capacity may be influenced by multiple factors, including staff availability. At the same time in the UK, we observed fundamental changes to health provision in the acute response of the pandemic, with for example the cancellation of routine operations and block booking of private health care providers to assist the NHS [@CoronavirusThousandsExtra2020], and the rapid creation of large scale field hospitals (). In previous work we examined the potential for redirecting patients from one region to another to balance the load of health care provision[@lacasaFlexibleMethodOptimising2020]. Taken together these changes have the potential to redefine the demographic and geographic profiles of health care service providers ("catchment areas" and "catchment populations")[@jonesModellingCatchmentAreas2011] on a day by day basis.

The catchment area or population of a hospital is a broad concept which serves a number of purposes, such as: 

* Definition of the primary population of a hospital (and their demographics) for strategic planning purposes [@wangCatchmentAreaAnalysis2015].
* Definition of higher level organizational structures and collaborative networks [@clarkeDefiningHospitalCatchment2019].
* Identification of areas with under, or over provision of services
* Calculation (and visualisation) of population prevalence from hospital reported statistics (identifying the denominator) [@gilmourIdentificationHospitalCatchment2010] and hence admission rates per head of population.
* Preferred routing of patients to hospitals for optimizing specific services.

There are complications in estimating catchment areas that arise in some parts of the UK. In England particularly, hospital sites are typically grouped into single organizational units (NHS trusts) which report combined activity. Thus a single unit of health-care provision (NHS trust) may have a range of physical locations, not all of which offer the full range of services. For example ICU provision is usually focused in a single hospital in an NHS Trust, whereas acute or step-down beds may be distributed across multiple sites. 

There are two general approaches to modelling catchment areas - activity based or algorithmic approaches. Activity based approaches minimally require data on hospital activity across all the region, such as individual patient admission records. Algorithmic approaches are based on information on regional demographics and hospital capacity, but do not require activity data. 

The individual modelling techniques result in a hospital catchment area that is either overlapping or non overlapping. An overlapping output reflects the fact that patients may have a choice in the use the services, and will cross arbitrarily imposed boundaries to access them, or the tertiary referral system described above. Non-overlapping outputs, which are less representative of reality, are generally simpler to use in subsequent analysis as they produce clear geographical demarcations, which are not at risk of double counting. It is often desirable such boundaries align with geographical and organizational boundaries.

The simplest algorithmic approaches involve straight line distance weighted to a measure of the size of hospital [@reillyLawRetailGravitation1931]. This can be extended by models which use an analogy to gravity to calculate the potential field of every hospital, based on both capacity (e.g. beds) and demand (e.g. patients) [@huffDefiningEstimatingTrading1964; @reillyLawRetailGravitation1931; @stewartInverseDistanceVariation1941]. The resulting potentials may be cut off at an specified value, or where they are exceeded by another hospitals potential, to produce either kind of output. Such algorithmic approaches may not respect geographical or existing organizational boundaries, but they can be used model hypothetical scenarios, such as the impact of creating a new hospital. Further details of the range of different models that have been proposed have been previously published[@jonesModellingCatchmentAreas2011;@gilmourIdentificationHospitalCatchment2010] and not reproduced here. 

Activity based models began with the proportional flow, or Norris-Bailey, model [@baileyStatisticsHospitalPlanning1956; @norrisRoleStatisticsRegional1952] which examines the proportion of patients from an area visiting a particular hospital versus the proportion of patients in an area who visit any health care provider. An extension of this was recently used to define catchment areas for major injury following acute trauma[@alexandrescuProposedApproachDefining2008]. More recently modern statistical approaches have been applied to the same basic activity data including k-Means classification [@gilmourIdentificationHospitalCatchment2010], Bayesian regression modelling. [@wangCatchmentAreaAnalysis2015] or Markov Multiscale Community Detection [@clarkeDefiningHospitalCatchment2019; @clarkeIdentifyingNaturallyOccurring2020]. Whilst providing an accurate reflection of reality, activity based models are predicated on the availability and recency of activity data, which may exhibit historical or cultural biases. Depending on the purpose of the catchment area such historical bias may or may not be desirable[@gilmourIdentificationHospitalCatchment2010].

In the early phase of the COVID-19 pandemic, a rapid estimate was needed of the potential demand on intensive care services as a result of observed and forecast infections, in the context of a changing landscape of health service provision. At this point, there was no comparable data with which to drive activity based models, and volatile estimates of hospital capacity. In order to plan provision of additional ventilators and high dependency beds, there was a pressing need for geographical catchment areas that could be used to translate regional epidemiological models of infections into a prediction of future admissions to individual hospitals. Based on the regional demographics an estimate could be made of the expected level of care the patients would need. This implied we needed a catchment area model that could interface with existing spatial boundaries implemented in epidemiological models and publicly available demographic estimates, and that fulfilled the following criteria:

* Create a clean one way mapping from low level geographic regions of demographics estimates and regional epidemiological model to the high level NHS trust.
* Provide contiguous and realistic subdivisions of geographies relating to a single hospital or to a group of hospitals in a single NHS trust.
* Provide areas that are determined by the capacity of hospital at different levels of care provision, and the density of local population, or anticipated size of outbreak in the local population.
* Create regions of approximately equal local supply (e.g. beds) and demand (e.g. patients) at boundaries.
* Respect physical geographical boundaries, such as large rivers.

We present an novel pragmatic algorithmic catchment area model designed to meet the needs of the COVID-19 pandemic, and which is inspired by label propagation for community detection in networks[@xieCommunityDetectionUsing2011; @xieLabelRankStabilizedLabel2013]. We provide some worked examples, and compare them to both manually created organizational boundaries, and to observed patient icu admissions during the first wave of the COVID 19 pandemic.

# Methods and materials

This section consists of 3 parts: a detailed description of the algorithmic catchment area model, a description of the data used to create initial outputs from the model, and a description of initial assessment of the model against available data.

## Algorithm

We assume the whole geographical region under consideration can be represented as a mathematical graph, $G$ and is divided into $N$ smaller regions, represented by the vertices $V_n$ (where $n \in \{1 \dots N\}$) each with known population of size $D(V_n)$ representing a demand on the service of interest (for this discussion we will use the example of hospital beds). 

We define $M$ hospitals located at the geographical points $P_m$ (where $m \in \{1 \dots M\}$), and with capacity to supply $S(P_m)$ beds. We constrain $P_m$ such that no more than one $P_m$ is found within any given $V$, i.e. no more than one hospital is found within any small region, and we assume that all areas in the region are connected to one another (i.e. graph $G$ is connected). 

The connections of neighbouring regions of any area $V_x$ are defined by $E_x = \nu(V_x)$, and likewise the set of neighbouring vertices of any subgraph $G_y$ are defined by $E_y = \nu(G_y)$. These quantities are readily calculated using the geographical intersection of different areas and various algorithms exist to calculate these from geo-spatial data [@bivandRgeosInterfaceGeometry2020; @pebesmaSimpleFeaturesStandardized2018].

The algorithm is inspired by label propagation network clustering, where labels correspond to the hospitals in our example, but where the rate of label propagation at every iteration of the algorithm is a function of both the size of the hospital, and the size of the population of the areas the label is propagating to. Our goal is to divide the graph $G$ into $M$ labelled sub-graphs $G_m$ such that the sub-graphs are connected, and that neighbouring sub-graphs have similar bed availability per unit population ($\frac{S_m}{D_m}$). We do this by assigning a score to every un-labelled region that neighbours a labelled region, and incrementing it by a small amount depending on the ratio of supply (hospital beds) and demand (population to be served). Thus labels propagate more quickly from points with a high capacity, to regions with a low population density than vice versa.

In practice the assumption that a maximum of one hospital is found in each region is occasionally not true. When this does happen, we preprocess the data to combine hospitals that are located together into a single entity. The assumptions that the geographical regions is fully connected does not hold for countries such as the UK which consist of islands and in this event we must add connections between geographically nearby regions to represent transport links, such as a bridge, or ferry. 

\begin{algorithm}[H]
\SetAlgoLined
\SetKwInOut{Input}{Input}
\SetKwInOut{Output}{Output}
\SetKwComment{Comment}{\--- }{}
\Input{$V_N$ - the $N$ supplied as a set of geographical polygons}
\Input{$D(V_x)$ - the density of demand in any given region as a function of the region $V_x$}
\Input{$P_M$ - a set of $M$ labelled supply points as a set of geographical points}
\Input{$S(P_y)$ - the capacity of supply at any given supply point as a function of the supplier $P_y$}
\Input{$C_{growth}$ - a rate constant defining rate of label propagation}
\Output{$G_M$ - $M$ labelled subgraphs of graph $G$, relating to the catchment areas of suppliers $P_M$}
\BlankLine

\Comment{define $G$ as the graph consisting of geographical regions $V_N$, connected by edges, $E_N$, given by their geographical neighbours $\nu(V_N)$:}
$E_N \gets \nu(V_N)$\;
$G \gets (V_N, E_N)$\;
\Comment{define $V_M$ as the geographic regions of $G$ containing points $P_M$, and $G_{M,0}$ as a set of labelled sub-graphs initially consisting solely of the vertices $V_M$:}
$V_M \gets G \cap P_M$\;
$G_{M,0} \gets V_M$\;
\Comment{define the initial unlabelled set of vertices:}
$U_0 \gets \neg V_{M}$\;
\Comment{define the initial un-labelled neighbours of labelled sub-graphs, $G_M$:}
$U_{M,0} \gets \nu(V_M)$\;
\Comment{define an accumulated growth score for each un-labelled neighbour $U_{M,0}$ of each $G_{M,0}$:}
$A_{U_{M,0}} \gets 0$\;
\BlankLine
$k \gets 0$\;
\While{$|U_k| > 0$} {
  $k \gets k+1$\;
  \BlankLine
  \Comment{define the un-labelled vertices as the set of $V$ not contained in any of $G_{M,k-1}$:}
  $U_k \gets \neg G_{M,k-1}$\;
  \Comment{define the un-labelled neighbours of $G_{M,k-1}$:}
  $U_{M,k} \gets U_k \cap \nu(G_{M,k-1})$\;
  \Comment{define the reserve capacity to supply existing labelled, $G_{M,k-1}$,  and un-labelled neighbours, $R_M$, as:}
  $R_M \gets \frac{S(P_M)}{D(U_{M,k} \cup G_{M,k-1})}$\;
  \Comment{update the accumulated growth score, $A_{U_{M,k}}$, with the normalised rank of the reserve capacity and multiplied by a constant $C_{growth} > 1$ representing the speed at which the accumulated growth score increases in all areas:}
  $A_{U_{M,k}} \gets A_{U_{M,k-1}} + C_{growth} \times \text{rank}(R_M)/|R_M|$\;
  \Comment{for all the un-labelled vertices, select the label $M$, with the highest score, and if the accumulated score has reached the threshold of 1, incorporate it into the labelled sub-graph, $G_{M,k-1}$:}
  $A^{max}_{U_k} = \text{max}(A_{U_{m,k}},m \in M)$\;
  $V^{new}_{M,k} \gets U_{M,k} \in \{A^{max}_{U_k} > 1\}$\;
  $G_{M,k} \gets G_{M,k-1} \cup V^{new}_{M,k}$\;
}
\Return{$G_{M,k}$}

\caption{A weighted label propagation algorithm for matching geographical supply to demand}
\end{algorithm} 

## Initial outputs

The algorithm requires population, geographical and hospital capacity data. For the UK there are detailed estimates of the population at granular geographic detail (lower super output area - LSOA11, and data zones DZ) available from the Office of National Statistics (ONS) for England and Wales, and the National Records Service (NRS) in Scotland [@PopulationEstimatesOffice; @teamNationalRecordsScotland2013]. These population estimates are by single year of age for each region which were combined to create a single population. Each geographical region is associated with a boundary file also provided by the ONS and NRS[@OpenGeographyPortal; @spatialdata.gov.scotDataZoneBoundaries2020].

Estimating the capacity of hospitals proved to be more complex than expected. The detail of the data sources we used in presented in the supplementary material, but in short we manually compiled a list of NHS and independent hospital sites and, where relevant, NHS trusts, from a range of different sources. When not provided, we identified their geographical locations from their postcode, and we estimated bed numbers from a combination of published NHS statistics, and from daily COVID-19 situation reports from early April 2020, provided by the NHS. The situation reports detailed both available beds at this point in time but also gave an indication of maximum surge capacity for high dependency beds. These data were manually curated and are indicative of the state of the NHS at maximal readiness. Bed state estimates for independent providers were also available through the situation reports.

In Northern Ireland, population estimates were not available at a similar geographical resolution as the ONS and NRS sources, and we are unaware of any publicly available hospital capacity estimates. They were therefore not included in this analysis.

<!-- ### Population data -->

<!-- * https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates -->
<!-- * https://www.nrscotland.gov.uk/statistics-and-data/statistics/statistics-by-theme/population/population-estimates/2011-based-special-area-population-estimates/small-area-population-estimates/time-series#2018 -->
<!-- * https://www.opendatani.gov.uk/dataset/3333626e-b96e-4b90-82fb-474c6c03b868/resource/64bd8dc4-935f-4bdd-9232-90ff33f24732/ -->

<!-- ### Map files -->

<!-- * LSOA11: https://geoportal.statistics.gov.uk/datasets/lower-layer-super-output-areas-december-2011-boundaries-ew-bgc -->
<!-- * DZ11: https://data.gov.uk/dataset/ab9f1f20-3b7f-4efa-9bd2-239acf63b540/data-zone-boundaries-2011 -->
<!-- * LGD12: https://data.gov.uk/dataset/05f72866-b72b-476a-b6f3-57bd4a768674/osni-open-data-largescale-boundaries-local-government-districts-2012 -->

## Validation

We have not tried to rigorously validate the accuracy of our method against others as there is no ground truth for the catchment areas for hospitals in the NHS during the COVID-19 pandemic. We did however look at two data sets that become available to give us an indication of the performance of the algorithm. 

The first is a list of postcodes associated with administrative boundaries for 4 NHS trusts in the South West which was provided to us by the NHS. The postcode regions were converted to LSOA11 codes using mapping files provided by the ONS (Source: Office for National Statistics licensed under the Open Government Licence v.3.0, containing OS data © Crown copyright and database right 2020 and Royal Mail data © Royal Mail copyright and database right 2020)[@OpenGeographyPortala]. The administratively defined catchment area for the 4 NHS trust were regarded as "observed" classifications, and the algorithmically defined as "predicted" classifications, allowing us to construct a confusion matrix.

Secondly, at a much later stage of the pandemic, we have been able to identify the coarse location (partial UK postcode, also known as outcode) from a list of admitted patients provided as part of the CHESS dataset[@SGSSCHESSData]. We used a postcode outcode map[@OpenDoorLogistics], LSOA11 and data zone demographic estimates, and an areal interpolation[@prenerArealArealWeighted2020] to generate an estimate of outcode based demographics. From this we apply our label propagation algorithm to determine outcode based catchment areas. As before we use outcodes of admitted patients, and the NHS trust they were admitted to as "observations" and use outcode based catchment area to predict the expected NHS trust for all patients. This is a multiclass classification consisting of several hundred classes, so we restricted ourselves to a overall accuracy measure as the total correctly assigned patients divided by total patients, and a qualitative analysis of the top 10 misclassified trusts.

# Results

```{r}
catch1 = dpc$capac$getNHSSiteIcuCatchment()
catch2a = dpc$capac$getNHSTrustIcuCatchment()
catch2b = dpc$capac$getNHSTrustAcuteCatchment()
```
`r fig("one")` a catchment area based on individual hospitals that offered high dependency beds during April 2020, and a regional demand based on full population estimates. This demonstrates the main desirable features of the catchment map in that the areas are contiguous, aligned with existing demographic boundaries, respect geographical boundaries such as large rivers, and on the whole produce areas that differ only marginally in the level or service provision from region to region. This last point is less true in areas where there are high densities of hospitals such as London where the algorithm, by design, cannot propagate from centrally located hospitals past more peripheral hospitals. This is discussed further below.

```{r}
p1a = ggplot(catch1$map)+geom_sf(aes(fill=hduBeds/count*100000), colour="grey50",size=0.1)+
  geom_sf(data=catch1$suppliers, mapping=aes(size=hduBeds), colour="orange",stroke=0.5,fill=NA,shape=1)#+
  


p2a = p1a+coord_sf(xlim=c(-0.5,0.2),ylim=c(51.3,51.7)) 

p1a = p1a+scale_fill_viridis_c(limit=c(0,75),oob=scales::squish,guide="none")+theme(plot.margin = unit(c(0,0,0,0),"pt"))+guides(colour="none", size="none")
p2a = p2a+scale_fill_viridis_c(limit=c(0,75),oob=scales::squish,guide=guide_colourbar("hdu beds per 100K pop",direction = "horizontal",title.position = "top"))+theme(plot.margin = unit(c(0,0,0,0),"pt"))+guides(colour="none", size=guide_bins("hdu beds",direction = "horizontal",title.position = "top"))

p3a = p1a | (p2a/patchwork::guide_area()) +patchwork::plot_layout(guides = "collect")

p3a %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/catchment-areas/HDU_UK_example")

```

`r fig("one","A LSOA/DZ based catchment area map estimated from the high dependency bed state in the UK in early April 2020, orange circles are NHS hospital sites with high dependency capacity and size. Map source: Office for National Statistics licensed under the Open Government Licence v.3.0, Contains OS data © Crown copyright and database right 2020")`

In `r fig("two")` we see the same algorithm applied to high dependency beds in panel A, and general hospital beds in panel B, this time at an NHS trust level. We see that the catchment areas are different for different levels of care, partly because of the addition of more hospitals associated with an NHS trust, expanding the geographical footprint of the NHS trust but also because additional smaller hospitals that can offer lower levels of care are included. In panels C and D we see the progression of the algorithm as it expands from each of the hospitals into the surrounding regions until encountering another catchment area.

```{r}
filledMap = function(catch, fillVar,supplyVar) {
  fillVar = ensym(fillVar)
  supplyVar = ensym(supplyVar)
  
  tmp = catch$suppliedArea 
  sf::st_crs(tmp) <- 4326
  
  return(ggplot()+geom_sf(data=tmp,size=0.1,mapping = aes(fill=!!fillVar),colour="grey60")+
  geom_sf(data=catch$map,size=0.2,colour="white",fill=NA)+
  geom_sf(data=catch$suppliers, mapping=aes(size=!!supplyVar), colour="orange",stroke=1,fill=NA,shape=1)+
  coord_sf(xlim=c(-5,-2.5),ylim=c(50,51.5))+
  #coord_sf(xlim=c(-0.5,0.5),ylim=c(51,52))+
  scale_size_continuous(guide="none"))
}

p1 = filledMap(catch2a,areaDemand,hduBeds)+
  scale_fill_viridis_c(limit=c(NA,4000),oob=scales::squish)

p2 = filledMap(catch2b,areaDemand,acuteBeds)+
  scale_fill_viridis_c(limit=c(NA,4000),oob=scales::squish)

p3 = filledMap(catch2a,iteration,hduBeds)+
  scale_fill_distiller(palette="Greys", limit = c(0,25))

p4 = filledMap(catch2b,iteration,acuteBeds)+
  scale_fill_distiller(palette="Greys", limit = c(0,25))

p5 = p1+p2+p3+p4+patchwork::plot_annotation(tag_levels = "A")+patchwork::plot_layout(ncol=2,guides = "collect")

p5 %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/catchment-areas/HDU_Acute_SW_example")

```
`r fig("two","Detail LSOA/DZ based catchment area map for NHS trusts estimated from the high dependency bed state, and general hospital bed states in the UK in early April 2020. In panel A orange circles are NHS hospital sites with high dependency capacity and in panel B they represent general hospital beds. In panel A and B the fill represents a measure of regional population. In Panel C & D the same regions are shown but this time the fill shows the iteration number at which the algorithm labelled a specific region. This demonstrates the propagating nature of the algortihm. Map source: Office for National Statistics licensed under the Open Government Licence v.3.0, Contains OS data © Crown copyright and database right 2020")`

`r fig("three")` summarises the result of the comparison of label propagation to administrative areas. The administrative assignments of postcode areas to four NHS trusts, the Royal Devon and Exeter (RD&E), Torbay, Plymouth (Plymth) and North Devon NHS trust (N Devn) are matched to the output of the label propagation algorithm for both high dependency (Panel A) and for general beds (Panel B). The resulting contingency table only involving the 4 areas under consideration.


```{r}
postcodes <- readxl::read_excel("~/Dropbox/covid19/catchment-areas/Locality Postcodes.xlsx")


evaluateCatchment = function(catch,postcodes,joinCode) {
  tmp = dpc$postcodes$getFullONS()
  tmp2 = postcodes %>% left_join(tmp %>% select(pcds,lsoa11),by=c("Postcode"="pcds")) %>% select(locality, lsoa11) %>% distinct()
  #sa = catch1$suppliedArea %>% as.tibble()
  tmp3 = catch$suppliedArea %>% as.data.frame() %>% select(areaId,supplierId) %>% full_join(tmp2,by=c("areaId"="lsoa11"))
  
  #tmp3 %>% filter(!is.na(locality)) %>% View()
  
  hosp = dpc$capac$getHospitals() %>% as.data.frame() %>% select(code,name,trustId,trustName)
  
  tmp3 = tmp3 %>% left_join(hosp,by=c("supplierId"=joinCode))
  confusion = tmp3 %>% mutate(
    observed = case_when(
      locality=="Northern locality" ~ "N Devn",
      locality=="Eastern locality" ~ "RD&E",
      locality=="Western locality" ~ "Plymth",
      locality=="Southern locality" ~ "Torbay",
      TRUE ~ "other"
      ),
    predicted = case_when(
      trustName=="Northern Devon Healthcare NHS Trust" ~ "N Devn",
      trustName=="Royal Devon and Exeter NHS Foundation Trust" ~ "RD&E",
      trustName=="University Hospitals Plymouth NHS Trust" ~ "Plymth",
      trustName=="Torbay and South Devon NHS Foundation Trust" ~ "Torbay",
      TRUE ~ "other")
  ) #%>% select(observed,predicted) %>% mutate(
  #  predicted = ordered(predicted,levels = c("RD&E","N Devn","Plymth","Torbay","other")),
  #  observed = ordered(observed,levels = c("RD&E","N Devn","Plymth","Torbay","other")),
  #)
  confusion %>% group_by(observed,predicted) %>% count()
  
  eval = cvms:::evaluate(confusion %>% filter(!(
    predicted=="other" | observed == "other"
  )),target_col = "observed",prediction_cols = "predicted", type="multinomial")
  return(eval)
}

hduEval = evaluateCatchment(catch1,postcodes,"code")
acuteEval = evaluateCatchment(catch2b,postcodes,"trustId")
```


```{r}

p6=cvms::plot_confusion_matrix(hduEval, class_order=c("RD&E","N Devn","Plymth","Torbay"), add_normalized = FALSE) #,"other"))
p6 = p6+xlab("Administrative assignment")+ylab("Label propagation")

p7=cvms::plot_confusion_matrix(acuteEval, class_order=c("RD&E","N Devn","Plymth","Torbay"),palette="Oranges", add_normalized = FALSE)
p7 = p7+xlab("Administrative assignment")+ylab("Label propagation")

(p6+p7+patchwork::plot_annotation(tag_levels = "A")+patchwork::plot_layout(ncol=2)) %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/catchment-areas/Confusion_matrix_SW")
```

`r fig("three","Contingency tables for the comparison of postcode classification to one of 4 NHS trusts by either a pre-existing administrative assignment, or by the label propagation method. The panel A ")`


Without a gold standard the evaluation is limited to the overall agreement which for high dependency was `r sprintf("%1.1f%%",hduEval[["Overall Accuracy"]]*100)` and for general hospital beds, `r sprintf("%1.1f%%",acuteEval[["Overall Accuracy"]]*100)`.

```{r}
dTmp = dpc$demog$getDemographicsForShape(mapId = "OUTCODE",ageBreaks = c(50),combineGenders = TRUE)
dTmp = dTmp %>% filter(ageCat == "50+") %>% ungroup() %>% select(-ageCat)
outcodeDemand = dpc$geog$getMap("OUTCODE") %>% left_join(dTmp, by=c("code","name"))

sariLL = dpc$spim$getSARI()
sariLL2 = sariLL %>% filter(admittedtoicu=="Yes") %>% select(caseid,trustcode,trustname,postcode)


acuteHospitals = dpc$capac$getHospitals() %>% dplyr::filter(acuteBeds>0 & sector=="NHS Sector")

catch = dpc$geog$createCatchment(
        supplyShape = acuteHospitals %>% dplyr::group_by(trustId,trustName), 
        supplyIdVar = trustId, 
        supplyVar = acuteBeds,
        demandId = "OUTCODE", 
        demandShape = outcodeDemand,
        demandIdVar = code, 
        demandVar = count,
        outputMap = TRUE
      )


sariLL4 = catch$suppliedArea %>% as.data.frame() %>% 
  select(areaId,supplierId) %>% 
  full_join(sariLL2,by=c("areaId"="postcode")) %>% 
  rename(predicted = supplierId, observed=trustcode) %>% 
  filter(!is.na(predicted) & !is.na(observed))

eval = cvms:::evaluate(sariLL4,target_col = "observed",prediction_cols = "predicted", type="multinomial")

agree = sariLL4 %>% filter(observed==predicted) %>% count() %>% pull(n)
total = sariLL4 %>% count() %>% pull(n)
acc = sprintf("%1.1f%%",eval$`Overall Accuracy`*100)
mcc = sprintf("%1.2f",eval$MCC)

# sariLL4 %>% mutate(match = observed==predicted) %>% group_by(match) %>% count() %>% ungroup() %>% mutate(percent = n/sum(n))
```

Lastly in our evaluation of the predictions of the label propagation algorithm against the observed admissions from the later stages of the pandemic we find across the whole country exact agreement in `r agree` out of `r total` cases, an accuracy of `r acc`, and the Matthew's correlation coefficient was `r mcc`. This lower accuracy is partly the result of the many possible output classes for predictions (one for each NHS trust). 

`r tab("one","The top 10 misclassified hospitals")`

```{r}
misclass = sariLL4 %>% filter(observed != predicted) %>% mutate(Trust = stringr::str_to_title(trustname)) %>% group_by(Trust) %>% count() %>% arrange(desc(n)) %>% head(10) %>% ungroup() %>% rename(`Errors`=n) 

misclass %>% standardPrintOutput::saveTable("~/Dropbox/covid19/catchment-areas/Non_matching_trusts")
top10misclass = sum(misclass$Errors)
```

In `r tab("one")` the top ten mis-classified hospitals are qualitatively examined which represent `r top10misclass` (`r sprintf("%1.1f%%",top10misclass/(total-agree)*100)`) of the mis-classifications. These 10 hospitals are all major tertiary referral intensive care units, or specialist centres. 

# Discussion

We have presented an algorithm for rapidly estimating hospital catchment areas for use when activity data is not available. We demonstrate how the output responds to the different capacities of the different levels of care provided (e.g. high dependency versus general hospital beds). We present catchment areas calculated using population size as demand, and total beds as capacity, which might be useful for longer term strategic service planning, but this algorithm is really designed to be part of an acute response to COVID-19 outbreak. In this case demand may be represented by local COVID-19 infection prevalence, and supply by staffed hospital beds. Our approach is novel in that it allows adaptation of local service provision to predictions of disease prevalence from epidemiological models of COVID-19 and real time bed states provided by NHS trusts. This allows us to model the degree of elasticity in the system to absorb localised shocks, caused by regional outbreaks, it gives us a better concept of when services are being at risk of becoming overwhelmed, and allow routing of new admissions away from overloaded hospitals.

Quantitative assessment of the performance of our algorithm is limited by the lack of a "gold standard". The finding that naive application of our algorithm to real world patient admission classifies only `r acc` correctly is explained by the qualitative analysis. The fact that all of the top 10 mis-classified trusts are major tertiary referral centres implies that our naive assumptions that catchment areas should be non overlapping is not strictly valid true in these cases. On the other hand the nature of the clinical service provided by tertiary referral centres is not directly comparable to that in smaller centres.

Overlapping catchment areas can also be modeled by multiple layers of non-overlapping catchment areas. When we consider the provision of intensive care services in the UK during COVID-19, we propose there are at least 3 layers of hospital service provision: there is a local service, which provides care for patients from nearby. A subset of hospitals additionally provide a regional, or tertiary referral, service layer which takes sicker patients from larger areas. The final layer is a crisis overflow layer provided that the NHS Nightingale field hospitals[@CoronavirusNightingaleHospital2020]. Each of these layers may be considered to have somewhat independent catchment areas. We propose that dividing the larger hospitals into local and regional services and considering the tertiary referral network as a second layer, with its own larger catchment area would improve the performance of the algorithm against real activity data. 

For our application we consider that catchment areas are not fixed. In such a layered model of catchment areas there is interplay between local layer demand for hospital beds and capacity for regional tertiary care provision, which will dynamically affect the "catchment area" for regional tertiary care provision, potentially on a day to day basis. In previous work we looked at the opportunities for balancing the load between different hospitals[@lacasaFlexibleLoadSharing2020] when transferring COVID-19 patients away from overloaded areas, however moving unwell patients between hospitals is ideally minimized. In this work we facilitate the dynamic re-specification of local service catchment areas and hospital tertiary referral networks, based on evolving demand. Coupled with flexible load sharing has interesting potential to model or influence patient admissions around the whole hospital network.

Hospital capacity is difficult to accurately estimate. One key input is an accurate assessment of demand in terms of population size or burden of disease, the other is an assessment of hospital capacity. During this work we discovered this is hard to estimate, as the ability of a hospital to provide a bed to a patient depends on a multitude of factors, such as staff availability. The ability of hospitals to absorb large numbers of emergency patients by reconfiguring their service provision (e.g cancelling routine operations) and providing overflow or "surge" high dependency capacity for short periods of time, further complicates estimates of supply. 

There are opportunities to extend our algorithm. The general approach of label propagation in networks has been more widely studied and newer approaches described [@xieCommunityDetectionUsing2011; @gregoryFindingOverlappingCommunities2010; @sunDetectingOverlappingCommunities2015] which allow overlapping communities. This may address some of the issues described above. These are appealing and a possible avenue for future extension of the algorithm. There persists however an open question about whether the overlapping nature of hospital service provision observed in activity data, is actually a result of the different services, or different levels of service, being provided by different hospitals to different catchment areas. Thus a specialist cancer hospital close to a specialist paediatric hospital will have geographically overlapping catchment areas, but in reality these hospitals are not providing the same service to the same population, and when this is taken into account we popose that a hospital's overall catchment area may be well modeled by a collection of catchment layers. 

# Conclusions

This label propagation algorithm for estimating hospital catchment areas is a pragmatic solution to determining geographical and demographic subsets of the population when there is no previous activity data available. It suits situations where the level of service provision and demand on the hospital system is dynamic, as has been the case in the COVID-19 pandemic. The algorithm is simple quick and satisfies the major criteria we set out in the introduction. The algorithm depends solely on data reflecting supply and geographical demand for a service, and as such is quite generic and potentially more widely applicable outside of medicine. Although we have discussed catchment areas in terms of the capacity of hosptial beds, and demand of local populations, there is nothing to prevent us defining capacity in any other way - a heuristic on staffing levels may be appropriate, or in different contexts, availability of medical imaging devices. Likewise, demand may be refined to reflect subpopulations are risk of disease, or may be the output of a predicitve model.

# References

<div id="refs"></div>

# Supplementary material - Estimating surge hospital capacity in Britain during the COVID-19 pandemic

Identifying a set of capacity data for the NHS proved complex. After several attempts to integrate data from various sources, we ultimately performed a manual curation of the sources listed below, with gaps or inconsistencies filled in by consultation with the relevant hospital's website. The resulting list is a snapshot in time of capacity and not representative of up to date practice. During the source of the COVID-19 pandemic a small number of NHS trusts merged which had to be adjusted for. There are also significant limitations due to the different ways the devolved administrations of the UK (England, Wales, Scotland and Northern Ireland) reported situation report of bed capacity durign the pandemic, which meant only England and Wales hospitals has assessments of surge capacity, and we had no reliable information about Northern Ireland at all, and hence it was excluded. This does not significantly alter our conclusions here about the nature of the algortihm, but should be bourne in mind, if the data set is to be used for other purposes.

___NHS and Trust GIS locations (England):___

* https://www.nhs.uk/about-us/nhs-website-datasets/
* Lists of independent and NHS hospitals and trusts with location data
* public

___NHS Trusts (England)___

* https://www.nhs.uk/ServiceDirectories/Pages/NHSTrustListing.aspx
* Lists of NHS trusts and locations (as postcode) with information about services offered and hospital sites
* public

___Beds open - NHS England:___

* https://www.england.nhs.uk/statistics/statistical-work-areas/bed-availability-and-occupancy/bed-data-overnight/
* https://www.england.nhs.uk/statistics/statistical-work-areas/bed-availability-and-occupancy/bed-data-day-only/
* Information at an NHS trusts level on hospital beds and icu beds available
* public

___Critical care capacity in England (pre-pandemic):___

* https://www.england.nhs.uk/statistics/statistical-work-areas/critical-care-capacity/critical-care-bed-capacity-and-urgent-operations-cancelled-2019-20-data/
* Prepandemic NHS trust bed and ICU capacity
* public

___Wales:___

Average daily beds by site:

* https://statswales.gov.wales/v/Hg4K
* Prepandemic ICU and general bed availability
* public

___Scotland:___

Annual trends in available beds:

* https://www.isdscotland.org/Health-Topics/Hospital-Care/Publications/data-tables2017.asp?id=2494#2494
* Prepandemic Hospital and ICU bed capacity
* public

___Sitrep (Situation reports) data:___

__England:__

* filename: Covid sitrep report incl CIC 20200408 FINAL.xlsx
* Acute and ICU beds available in England at site level
* ICU (SIT032) and HDU (SIT033) beds available - many data quality issues and missing trusts
* restricted

__Wales:__

* filename: NHSWalesCovid19Sitrep-20200408.csv
* Acute and ICU beds available in Wales
* restricted

N.B. No sitrep data for Scotland or for Northern Ireland

```{r}

dpc$capac$getHospitals() %>% as.data.frame() %>% 
  readr::write_csv("~/Dropbox/covid19/catchment-areas/UK-COVID-surge-capacity-april-2020.csv")
  # select(trustName,name,pcds,acuteBeds,hduBeds) %>% 
  # mutate(acuteBeds = sprintf("%1.0f",acuteBeds),hduBeds = sprintf("%1.0f",hduBeds)) %>% group_by(trustName) %>%
  # standardPrintOutput::saveMultiPageTable("~/Dropbox/covid19/catchment-areas/HospitalList",colWidths = c(2,3,1,1,1),defaultFontSize = 7)
```

